#! /bin/sh

master=develop  # the master branch

debug() {
    echo "$(basename "$0"): " "$@" >&2
}

branch="$(git symbolic-ref --short HEAD)"
ticket="$(echo "$branch" | sed 's/^\([a-zA-Z][a-zA-Z]*-[0-9][0-9]*\)-.*/\1/')"

if [ -z "$ticket" ] ; then
    debug "not in a working branch"
    if [ -z "$1" ] ; then
        debug "specify a ticket if you want to close it."
        exit 1
    fi
    ticket=$1
    branch=''
fi


# check that ticket is in starting state
status=$(jira view --gjq='fields.status.name' "$ticket")
if [ "$status" != "In Progress" ] ; then
    debug "$ticket is not \`In Progress'.  Fix"
    exit 1
fi

# check that all changes are committed
if [ -n "$(git status --porcelain --untracked-files=no | tail -n 1)" ]; then
    debug "Commit all your changes to $ticket first"
    exit 1
fi

#
# move jira ticket to resolved
# 
jira transition 'Problem fixed & merged' "$ticket" --noedit

git co "$master"

#
# move jira ticket to closed
#
jira transition 'Fix accepted by reporter' "$ticket" --noedit

#
# update master branch in workspace.
#
git pull
exit
